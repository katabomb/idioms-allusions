<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Idioms & Allusionsï¼ˆè‹±èªæˆå¥ãƒ»å…¸æ‹ ï¼‰</title>
<style>
  :root{--w:860px;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;display:flex;justify-content:center;background:#fafafa;color:#222}
  .wrap{width:min(100%,var(--w))}
  h1{font-size:22px;margin:0 0 12px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 16px}
  .card{border:1px solid #ddd;border-radius:14px;padding:18px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.05)}
  .row{margin:8px 0}
  .label{font-weight:600;color:#444;display:inline-block;width:10.5em;vertical-align:top}
  .value{white-space:pre-wrap}
  .title{font-size:22px;font-weight:700;margin-bottom:8px}
  .muted{color:var(--muted);font-size:12px}
  button{padding:8px 14px;border:1px solid #ccc;border-radius:10px;background:#fff;cursor:pointer}
  button:hover{background:#f3f3f3}
  button:disabled{opacity:.5;cursor:not-allowed}
  input[type="file"]{padding:6px}
  input[type="range"]{width:180px}
  .counter{margin-left:auto;font-variant-numeric:tabular-nums}
  #err{margin-top:10px;color:#b00020;white-space:pre-wrap}
  .hl{background:#fff5a8;border-radius:6px;padding:0 2px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Idioms & Allusions <span class="muted">ï¼ˆè‹±èªæˆå¥ãƒ»å…¸æ‹ ï¼‰</span></h1>
  <div class="toolbar">
    <input id="fileInput" type="file" accept=".csv" />
    <button id="prevBtn" disabled>â—€ å‰ã¸</button>
    <button id="nextBtn" disabled>æ¬¡ã¸ â–¶</button>
    <button id="randBtn" disabled>ğŸ”€ ãƒ©ãƒ³ãƒ€ãƒ </button>
    <button id="speakBtn" disabled>ğŸ”Š èª­ã¿ä¸Šã’</button>
    <button id="stopBtn" disabled>â¹ åœæ­¢</button>
    <span class="counter" id="counter">0 / 0</span>
  </div>
  <div class="toolbar" style="margin-top:-6px">
    <label class="muted">é€Ÿåº¦ <span id="rateVal">(1.00)</span></label>
    <input id="rate" type="range" min="0.6" max="1.6" step="0.05" value="1.0" />
    <label class="muted" style="display:flex;align-items:center;gap:6px">
      <input id="autoToggle" type="checkbox" checked /> æ–°è¦è¡¨ç¤ºã§è‡ªå‹•èª­ã¿ä¸Šã’ï¼ˆè‹±èªè¡¨ç¾â†’ä¾‹æ–‡ï¼‰
    </label>
    <label class="muted" style="display:flex;align-items:center;gap:6px">
      <input id="highlightToggle" type="checkbox" checked /> æ–‡ã”ã¨ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    </label>
  </div>

  <div id="card" class="card">
    <div class="title" id="è‹±èªè¡¨ç¾">CSV ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
    <div class="row"><span class="label">æ„å‘³</span><span class="value" id="æ„å‘³">â€”</span></div>
    <div class="row"><span class="label">ç”±æ¥</span><span class="value" id="ç”±æ¥">â€”</span></div>
    <div class="row"><span class="label">ä¾‹æ–‡</span><span class="value" id="ä¾‹æ–‡">â€”</span></div>
    <div class="row"><span class="label">æ—¥æœ¬èªè¨³</span><span class="value" id="æ—¥æœ¬èªè¨³">â€”</span></div>
    <div class="row"><span class="label">è¿‘ã„æ—¥æœ¬èªè¡¨ç¾</span><span class="value" id="è¿‘ã„æ—¥æœ¬èªè¡¨ç¾">â€”</span></div>
    <div class="muted">â€» åˆ—ã¯ã€Œè‹±èªè¡¨ç¾, æ„å‘³, ç”±æ¥, ä¾‹æ–‡, æ—¥æœ¬èªè¨³, è¿‘ã„æ—¥æœ¬èªè¡¨ç¾ã€ã‚’æƒ³å®šï¼ˆè¡¨è¨˜ã‚†ã‚Œå¯¾å¿œï¼‰</div>
    <div id="err"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// ä¿®æ­£ç‰ˆï¼šä¾‹æ–‡ãŒå‰ã®ã‚‚ã®ã«æ®‹ã‚‹å•é¡Œã®å¯¾ç­–
// 1) ç”»é¢æ›´æ–°ãƒˆãƒ¼ã‚¯ãƒ³(viewToken)ã§å¤ã„TTSã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–
// 2) ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«å¿…ãšTTSã‚’åœæ­¢
// 3) è¡¨ç¤ºåˆ‡æ›¿æ™‚ã«ä¾‹æ–‡ã‚’éƒ½åº¦æç”»ã—ç›´ã—

let rows = [], idx = 0;
const ids = [\"è‹±èªè¡¨ç¾\",\"æ„å‘³\",\"ç”±æ¥\",\"ä¾‹æ–‡\",\"æ—¥æœ¬èªè¨³\",\"è¿‘ã„æ—¥æœ¬èªè¡¨ç¾\"];
const els = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));
let exampleEl = document.getElementById('ä¾‹æ–‡'); // ä¾‹æ–‡ãƒãƒ¼ãƒ‰å‚ç…§ï¼ˆå¾Œã§å®Œå…¨å·®ã—æ›¿ãˆï¼‰;
const counter = document.getElementById('counter');
const errBox = document.getElementById('err');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const randBtn = document.getElementById('randBtn');
const speakBtn = document.getElementById('speakBtn');
const stopBtn = document.getElementById('stopBtn');
const rate = document.getElementById('rate');
const rateVal = document.getElementById('rateVal');
const highlightToggle = document.getElementById('highlightToggle');
const autoToggle = document.getElementById('autoToggle');
let userInteracted = false; // iOSå¯¾ç­–: åˆå›ã¯æ“ä½œå¾Œã«è‡ªå‹•å†ç”Ÿ
let viewToken = 0;          // ç”»é¢æ›´æ–°ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆãƒ¬ãƒ¼ã‚¹é˜²æ­¢ï¼‰

function updateRateLabel(){ rateVal.textContent = '(' + Number(rate.value).toFixed(2) + ')'; }
updateRateLabel();
rate.addEventListener('input', updateRateLabel);

function show(i){
  const r = rows[i]; if(!r) return;
  viewToken++;
  stopSpeech();
  els["è‹±èªè¡¨ç¾"].textContent = r["è‹±èªè¡¨ç¾"]||"â€”";
  els["æ„å‘³"].textContent = r["æ„å‘³"]||"â€”";
  els["ç”±æ¥"].textContent = r["ç”±æ¥"]||"â€”";
  renderExample(r["ä¾‹æ–‡"]||"");
  els["æ—¥æœ¬èªè¨³"].textContent = r["æ—¥æœ¬èªè¨³"]||"â€”";
  els["è¿‘ã„æ—¥æœ¬èªè¡¨ç¾"].textContent = r["è¿‘ã„æ—¥æœ¬èªè¡¨ç¾"]||"â€”";
  counter.textContent = `${idx+1} / ${rows.length}`;
  if(autoToggle.checked){
    if(userInteracted){
      const token = viewToken;
      requestAnimationFrame(()=> setTimeout(()=>{ if(token===viewToken) autoSpeakCurrent(); }, 0));
    } else {
      showAutoHint();
    }
  }
} / ${rows.length}`;
  if(autoToggle.checked){
    if(userInteracted){ stopSpeech(); autoSpeakCurrent(); }
    else showAutoHint();
  }
}

function enableNav(enable){
  [prevBtn,nextBtn,randBtn,speakBtn,stopBtn].forEach(b=>b.disabled=!enable);
}

// æ–‡åˆ†å‰²ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
function splitSentences(text){
  if(!text) return [];
  const cleaned = text.replace(/\s+/g,' ').trim();
  if(!cleaned) return [];
  const parts = cleaned.match(/[^.!?]+[.!?]*/g) || [cleaned];
  return parts.map(s=>s.trim()).filter(Boolean);
}

// ä¾‹æ–‡ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæç”»
let currentSentences = [];
function renderExample(text){
  currentSentences = splitSentences(text);
  const newEl = exampleEl.cloneNode(false);
  newEl.id = 'ä¾‹æ–‡';
  if(!currentSentences.length){
    newEl.textContent = 'â€”';
  } else {
    newEl.innerHTML = currentSentences.map((s,i)=>`<span data-i="${i}">${escapeHtml(s)}</span>${i<currentSentences.length-1?' ':''}`).join('');
  }
  exampleEl.replaceWith(newEl);
  exampleEl = newEl;
  clearHighlight();
}
  els[\"ä¾‹æ–‡\"].innerHTML = currentSentences.map((s,i)=>`<span data-i=\"${i}\">${escapeHtml(s)}</span>${i<currentSentences.length-1?' ':''}`).join('');
  clearHighlight();
}
function setHighlight(i){
  if(!highlightToggle.checked) return;
  const spans = els[\"ä¾‹æ–‡\"].querySelectorAll('span');
  spans.forEach((sp,idx)=>{ if(idx===i) sp.classList.add('hl'); else sp.classList.remove('hl'); });
}
function clearHighlight(){ const spans = els[\"ä¾‹æ–‡\"].querySelectorAll('span'); spans.forEach(sp=>sp.classList.remove('hl')); }
function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c])); }

// CSVèª­ã¿è¾¼ã¿ï¼ˆCSVå°‚ç”¨ï¼‰
function loadCSV(file){
  Papa.parse(file, {
    header:true, skipEmptyLines:true,
    complete: ({data,meta}) => {
      const fields = meta.fields || Object.keys(data[0]||{});
      const pick = (o, keys) => { for(const k of keys){ if(o[k]!=null && o[k]!===\"\") return String(o[k]); } return \"\"; };
      rows = data.map(r=>({
        \"è‹±èªè¡¨ç¾\": pick(r, [\"è‹±èªè¡¨ç¾\",\"Idiom\",\"Term\",\"è‹±èª\",\"English\"]),
        \"æ„å‘³\": pick(r, [\"æ„å‘³\",\"Meaning\"]),
        \"ç”±æ¥\": pick(r, [\"ç”±æ¥\",\"Origin\",\"èªæº\"]),
        \"ä¾‹æ–‡\": pick(r, [\"ä¾‹æ–‡\",\"Example\",\"Sentence\"]),
        \"æ—¥æœ¬èªè¨³\": pick(r, [\"æ—¥æœ¬èªè¨³\",\"Translation\",\"å’Œè¨³\"]),
        \"è¿‘ã„æ—¥æœ¬èªè¡¨ç¾\": pick(r, [\"è¿‘ã„æ—¥æœ¬èªè¡¨ç¾\",\"é¡ä¼¼è¡¨ç¾\",\"å¯¾å¿œè¡¨ç¾\"]),
      })).filter(r=>Object.values(r).some(v=>v));
      if(rows.length){ idx=0; show(idx); enableNav(true); errBox.textContent=''; }
      else{ errBox.textContent = 'CSVãŒç©ºã‹åˆ—åãŒä¸ä¸€è‡´ã§ã™ï¼ˆUTF-8æ¨å¥¨ï¼‰ã€‚æ¤œå‡ºãƒ˜ãƒƒãƒ€ãƒ¼: '+fields.join(' | '); enableNav(false); }
    },
    error: (err) => { errBox.textContent = 'CSVã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼: '+err; enableNav(false); }
  });
}

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¿…ãšåœæ­¢â†’è¡¨ç¤ºï¼‰
nextBtn.onclick=()=>{ userInteracted=true; if(rows.length){ idx=(idx+1)%rows.length; show(idx); } };
prevBtn.onclick=()=>{ userInteracted=true; if(rows.length){ stopSpeech(); idx=(idx-1+rows.length)%rows.length; show(idx); } };
randBtn.onclick=()=>{ userInteracted=true; if(rows.length){ stopSpeech(); idx=Math.floor(Math.random()*rows.length); show(idx); } };

// éŸ³å£°ï¼ˆè‹±èªã®ã¿ï¼‰
let speaking = false, currentIndex = -1;
function getEnglishVoice(){
  const voices = window.speechSynthesis.getVoices();
  return voices.find(v=>/^en(\b|[-_])/i.test(v.lang)) || voices[0] || null;
}
function speakIdiomAndExample(idiom, sentences, token){
  const queue = [];
  if(idiom) queue.push({type:'idiom', text: idiom});
  sentences.forEach((s,i)=> queue.push({type:'sent', index:i, text:s}));
  if(!queue.length) return;
  speaking = true; currentIndex = 0; clearHighlight();
  const next = () => {
    // ç”»é¢æ›´æ–°æ¸ˆã¿ãªã‚‰å¤ã„å†ç”Ÿã¯ç„¡åŠ¹åŒ–
    if(token !== viewToken){ speaking=false; currentIndex=-1; return; }
    if(currentIndex >= queue.length){ speaking=false; currentIndex=-1; clearHighlight(); return; }
    const item = queue[currentIndex];
    const u = new SpeechSynthesisUtterance(item.text);
    const v = getEnglishVoice(); if(v) u.voice = v;
    u.rate = Number(rate.value)||1; u.pitch = 1; u.volume = 1;
    u.onend = () => { if(token !== viewToken) return; currentIndex++; if(item.type==='sent') setHighlight(item.index+1); else setHighlight(0); next(); };
    u.onerror = () => { if(token !== viewToken) return; currentIndex++; next(); };
    if(item.type==='sent') setHighlight(item.index); else clearHighlight();
    window.speechSynthesis.speak(u);
  };
  window.speechSynthesis.cancel();
  next();
}
function stopSpeech(){ window.speechSynthesis.cancel(); speaking=false; currentIndex=-1; clearHighlight(); }

function autoSpeakCurrent(){
  const r = rows[idx];
  const sentences = splitSentences(r[\"ä¾‹æ–‡\"]||\"\");
  const idiom = (r[\"è‹±èªè¡¨ç¾\"]||\"\").trim();
  const token = viewToken; // ç¾åœ¨ã®ç”»é¢ãƒˆãƒ¼ã‚¯ãƒ³
  speakIdiomAndExample(idiom, sentences, token);
}

speakBtn.onclick=()=>{ userInteracted=true; if(!rows.length) return; stopSpeech(); autoSpeakCurrent(); };
stopBtn.onclick=()=>{ userInteracted=true; stopSpeech(); };

// ä¾‹æ–‡å†…ã®ã‚¯ãƒªãƒƒã‚¯ã§ãã®æ–‡ã‹ã‚‰å†ç”Ÿ
els[\"ä¾‹æ–‡\"].addEventListener('click',(e)=>{
  userInteracted = true;
  const sp = e.target.closest('span[data-i]');
  if(!sp) return;
  const i = Number(sp.dataset.i||'-1');
  if(i<0) return;
  stopSpeech();
  const sentences = currentSentences.slice(i);
  const token = viewToken;
  speakIdiomAndExample('', sentences, token); // idiomã¯çœç•¥ã—ã¦ã€ãã®æ–‡ã‹ã‚‰
});

// è‡ªå‹•èª­ã¿ä¸Šã’ã®ãƒ’ãƒ³ãƒˆï¼ˆiOSåˆå›ï¼‰
function showAutoHint(){
  if(document.getElementById('autoHint')) return;
  const hint = document.createElement('div');
  hint.id='autoHint';
  hint.className='muted';
  hint.textContent='ï¼ˆãƒ’ãƒ³ãƒˆï¼‰iPhone/iPadã¯åˆå›ã«ä½•ã‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨è‡ªå‹•èª­ã¿ä¸Šã’ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚';
  document.querySelector('.wrap').insertBefore(hint, document.getElementById('card'));
}

// CSVã®ã¿
fileInput.addEventListener('change',e=>{
  userInteracted = true;
  const f=e.target.files?.[0]; if(!f) return;
  if(!f.name.toLowerCase().endsWith('.csv')){ errBox.textContent='CSVãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.csvï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„'; enableNav(false); return; }
  stopSpeech();
  loadCSVsmart(f);
});

// ã©ã“ã‹ã‚’ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã—ãŸã‚‰è¨±å¯ã•ã‚ŒãŸã¨ã¿ãªã™
window.addEventListener('pointerdown', ()=>{ userInteracted = true; });
// è³¢ã„CSVãƒ­ãƒ¼ãƒ€ï¼ˆåŒºåˆ‡ã‚Š/æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼‰
function loadCSVsmart(file){
  const tryConfigs = [
    {header:true, skipEmptyLines:true},                    // è‡ªå‹•åˆ¤å®šï¼ˆã‚«ãƒ³ãƒ/ã‚¿ãƒ–ï¼‰
    {header:true, skipEmptyLines:true, delimiter:'	'},   // æ˜ç¤ºã‚¿ãƒ–
    {header:true, skipEmptyLines:true, encoding:'Shift_JIS'},
    {header:true, skipEmptyLines:true, delimiter:'	', encoding:'Shift_JIS'}
  ];
  let tried = 0;
  const attempt = () => {
    if(tried >= tryConfigs.length){
      errBox.textContent = 'CSVãŒç©ºã‹åˆ—åãŒä¸ä¸€è‡´ã§ã™ï¼ˆUTF-8æ¨å¥¨ï¼‰ã€‚Excelç”±æ¥ãªã‚‰ã€ŒCSV UTF-8 (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)ã€ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚';
      enableNav(false);
      return;
    }
    const cfg = tryConfigs[tried++];
    Papa.parse(file, {
      ...cfg,
      complete: ({data,meta}) => {
        const fields = meta.fields || Object.keys(data[0]||{});
        const pick = (o, keys) => { for(const k of keys){ if(o[k]!=null && o[k]!=="") return String(o[k]); } return ""; };
        const mapped = data.map(r=>({
          "è‹±èªè¡¨ç¾": pick(r, ["è‹±èªè¡¨ç¾","Idiom","Term","è‹±èª","English"]),
          "æ„å‘³": pick(r, ["æ„å‘³","Meaning"]),
          "ç”±æ¥": pick(r, ["ç”±æ¥","Origin","èªæº"]),
          "ä¾‹æ–‡": pick(r, ["ä¾‹æ–‡","Example","Sentence"]),
          "æ—¥æœ¬èªè¨³": pick(r, ["æ—¥æœ¬èªè¨³","Translation","å’Œè¨³"]),
          "è¿‘ã„æ—¥æœ¬èªè¡¨ç¾": pick(r, ["è¿‘ã„æ—¥æœ¬èªè¡¨ç¾","é¡ä¼¼è¡¨ç¾","å¯¾å¿œè¡¨ç¾"]),
        })).filter(r=>Object.values(r).some(v=>v));
        if(mapped.length){ rows = mapped; idx=0; show(idx); enableNav(true); errBox.textContent=''; }
        else { attempt(); }
      },
      error: () => attempt()
    });
  };
  attempt();
}
</script>
<script>
// ===== Robust CSV loader + TTS viewer =====
let rows = [], idx = 0, viewToken = 0;
const ids = ["è‹±èªè¡¨ç¾","æ„å‘³","ç”±æ¥","ä¾‹æ–‡","æ—¥æœ¬èªè¨³","è¿‘ã„æ—¥æœ¬èªè¡¨ç¾"];
const els = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));
let exampleEl = document.getElementById('ä¾‹æ–‡');
const counter = document.getElementById('counter');
const errBox = document.getElementById('err');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const randBtn = document.getElementById('randBtn');
const speakBtn = document.getElementById('speakBtn');
const stopBtn = document.getElementById('stopBtn');
const rate = document.getElementById('rate');
const rateVal = document.getElementById('rateVal');
const highlightToggle = document.getElementById('highlightToggle');
const autoToggle = document.getElementById('autoToggle');
const fileInput = document.getElementById('fileInput');
let userInteracted = false;

function updateRateLabel(){ rateVal.textContent = '(' + Number(rate.value).toFixed(2) + ')'; }
updateRateLabel();
rate.addEventListener('input', updateRateLabel);

function enableNav(on){ [prevBtn,nextBtn,randBtn,speakBtn,stopBtn].forEach(b=>b.disabled=!on); }

function show(i){
  const r = rows[i]; if(!r) return;
  viewToken++;
  stopSpeech();
  els["è‹±èªè¡¨ç¾"].textContent = r["è‹±èªè¡¨ç¾"]||"â€”";
  els["æ„å‘³"].textContent = r["æ„å‘³"]||"â€”";
  els["ç”±æ¥"].textContent = r["ç”±æ¥"]||"â€”";
  renderExample(r["ä¾‹æ–‡"]||"");
  els["æ—¥æœ¬èªè¨³"].textContent = r["æ—¥æœ¬èªè¨³"]||"â€”";
  els["è¿‘ã„æ—¥æœ¬èªè¡¨ç¾"].textContent = r["è¿‘ã„æ—¥æœ¬èªè¡¨ç¾"]||"â€”";
  counter.textContent = `${idx+1} / ${rows.length}`;
  if(autoToggle.checked){
    if(userInteracted){
      const t=viewToken;
      requestAnimationFrame(()=>setTimeout(()=>{ if(t===viewToken) autoSpeakCurrent(); },0));
    } else {
      showAutoHint();
    }
  }
}

// ------- Example rendering & highlight -------
let currentSentences = [];
function splitSentences(text){
  if(!text) return [];
  const cleaned = String(text).replace(/\s+/g,' ').trim();
  if(!cleaned) return [];
  const parts = cleaned.match(/[^.!?]+[.!?]*/g) || [cleaned];
  return parts.map(s=>s.trim()).filter(Boolean);
}
function renderExample(text){
  currentSentences = splitSentences(text);
  const newEl = exampleEl.cloneNode(false); newEl.id = 'ä¾‹æ–‡';
  if(!currentSentences.length){ newEl.textContent='â€”'; }
  else { newEl.innerHTML = currentSentences.map((s,i)=>`<span data-i="${i}">${escapeHtml(s)}</span>${i<currentSentences.length-1?' ':''}`).join(''); }
  exampleEl.replaceWith(newEl); exampleEl = newEl; clearHighlight();
}
function setHighlight(i){
  if(!highlightToggle.checked) return;
  const spans=exampleEl.querySelectorAll('span');
  spans.forEach((sp,idx)=>{ if(idx===i) sp.classList.add('hl'); else sp.classList.remove('hl'); });
}
function clearHighlight(){ const spans=exampleEl.querySelectorAll('span'); spans.forEach(sp=>sp.classList.remove('hl')); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

// å†ç”Ÿï¼šä¾‹æ–‡å†…ã‚¯ãƒªãƒƒã‚¯ã§ãã®æ–‡ã‹ã‚‰
exampleEl.addEventListener('click',(e)=>{
  userInteracted = true;
  const sp = e.target.closest('span[data-i]'); if(!sp) return;
  const i = Number(sp.dataset.i); stopSpeech(); const rest = currentSentences.slice(i);
  speakIdiomAndExample('', rest);
});

// ------- CSV loader (robust) -------
// ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¦‹ãˆãªã„BOMã‚„å…¨è§’ç©ºç™½ã‚‚é™¤å»ã—ã¦æ­£è¦åŒ–
function normalizeHeader(h){ return String(h||'').replace(/\uFEFF/g,'').replace(/[\s\u3000]+/g,'').trim(); }
const headerAliases = {
  è‹±èªè¡¨ç¾:['è‹±èªè¡¨ç¾','Idiom','Term','è‹±èª','English'],
  æ„å‘³:['æ„å‘³','Meaning'],
  ç”±æ¥:['ç”±æ¥','Origin','èªæº'],
  ä¾‹æ–‡:['ä¾‹æ–‡','Example','Sentence'],
  æ—¥æœ¬èªè¨³:['æ—¥æœ¬èªè¨³','Translation','å’Œè¨³'],
  è¿‘ã„æ—¥æœ¬èªè¡¨ç¾:['è¿‘ã„æ—¥æœ¬èªè¡¨ç¾','é¡ä¼¼è¡¨ç¾','å¯¾å¿œè¡¨ç¾']
};
const aliasNorm = Object.fromEntries(Object.entries(headerAliases).map(([k,arr])=>[k,arr.map(normalizeHeader)]));

fileInput.addEventListener('change',e=>{
  userInteracted = true; const f=e.target.files?.[0]; if(!f) return;
  if(!f.name.toLowerCase().endsWith('.csv')){ errBox.textContent='CSVãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.csvï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„'; enableNav(false); return; }
  loadCSVsmart(f);
});

// ã‚«ãƒ³ãƒ/ã‚¿ãƒ–ã®ä¸¡æ–¹ã‚’è©¦ã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ transform ã§æ­£è¦åŒ–
function loadCSVsmart(file){
  const tryConfigs = [
    {header:true, skipEmptyLines:true, transformHeader: h=>normalizeHeader(h)},
    {header:true, skipEmptyLines:true, delimiter:'\t', transformHeader: h=>normalizeHeader(h)}
  ];
  let tried = 0;
  const attempt = () => {
    if(tried >= tryConfigs.length){
      errBox.textContent='CSVãŒç©ºã‹åˆ—åãŒä¸ä¸€è‡´ã§ã™ã€‚Excelãªã‚‰ã€ŒCSV UTF-8 (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)ã€ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚';
      enableNav(false); return;
    }
    const cfg = tryConfigs[tried++];
    Papa.parse(file, {
      ...cfg,
      complete: ({data,meta}) => {
        const fields = (meta.fields||[]).map(normalizeHeader);
        const mapped = data.map(orig => {
          // æ­£è¦åŒ–ã‚­ãƒ¼ã§å‚ç…§
          const o = {}; Object.keys(orig||{}).forEach(k=>{ o[normalizeHeader(k)] = orig[k]; });
          const out = {};
          for(const [canon, keys] of Object.entries(aliasNorm)){
            out[canon] = '';
            for(const k of keys){ if(o[k] != null && o[k] !== ''){ out[canon] = String(o[k]); break; } }
          }
          return out;
        }).filter(r=>Object.values(r).some(v=>v));
        if(mapped.length){ rows = mapped; idx=0; show(idx); enableNav(true); errBox.textContent=''; }
        else { errBox.textContent = 'ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¤œå‡º: '+fields.join(' | '); attempt(); }
      },
      error: () => attempt()
    });
  };
  attempt();
}

// ------- TTS (English only) -------
let speaking=false, currentIndex=-1;
function getEnglishVoice(){ const vs = window.speechSynthesis.getVoices(); return vs.find(v=>/^en(\b|[-_])/i.test(v.lang)) || vs[0] || null; }
function speakIdiomAndExample(idiom, sentences){
  const queue=[]; if(idiom) queue.push({type:'idiom', text:idiom}); sentences.forEach((s,i)=>queue.push({type:'sent', index:i, text:s}));
  if(!queue.length) return; speaking=true; currentIndex=0; clearHighlight();
  const token=viewToken;
  const next=()=>{
    if(!speaking || token!==viewToken) { speaking=false; return; }
    if(currentIndex>=queue.length){ speaking=false; currentIndex=-1; clearHighlight(); return; }
    const item=queue[currentIndex]; const u=new SpeechSynthesisUtterance(item.text); const v=getEnglishVoice(); if(v) u.voice=v;
    u.rate=Number(rate.value)||1; u.pitch=1; u.volume=1;
    u.onend=()=>{ currentIndex++; if(item.type==='sent') setHighlight(item.index+1); else setHighlight(0); next(); };
    u.onerror=()=>{ currentIndex++; next(); };
    if(item.type==='sent') setHighlight(item.index); else clearHighlight();
    window.speechSynthesis.speak(u);
  };
  window.speechSynthesis.cancel(); next();
}
function stopSpeech(){ window.speechSynthesis.cancel(); speaking=false; currentIndex=-1; clearHighlight(); }
function autoSpeakCurrent(){ const r=rows[idx]; const sentences=splitSentences(r["ä¾‹æ–‡"]||""); const idiom=(r["è‹±èªè¡¨ç¾"]||'').trim(); speakIdiomAndExample(idiom, sentences); }

// Nav + UX
nextBtn.onclick=()=>{ userInteracted=true; if(rows.length){ idx=(idx+1)%rows.length; show(idx); } };
prevBtn.onclick=()=>{ userInteracted=true; if(rows.length){ idx=(idx-1+rows.length)%rows.length; show(idx); } };
randBtn.onclick=()=>{ userInteracted=true; if(rows.length){ idx=Math.floor(Math.random()*rows.length); show(idx); } };
speakBtn.onclick=()=>{ userInteracted=true; if(!rows.length) return; autoSpeakCurrent(); };
stopBtn.onclick=()=>{ userInteracted=true; stopSpeech(); };

function showAutoHint(){
  if(document.getElementById('autoHint')) return;
  const hint=document.createElement('div');
  hint.id='autoHint'; hint.className='muted';
  hint.textContent='ï¼ˆãƒ’ãƒ³ãƒˆï¼‰iPhone/iPadã¯åˆå›ã«ä½•ã‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨è‡ªå‹•èª­ã¿ä¸Šã’ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚';
  document.querySelector('.wrap').insertBefore(hint, document.getElementById('card'));
}
window.addEventListener('pointerdown', ()=>{ userInteracted=true; });
</script>
</body>
</html>
